<section class="hb-media-library-page">
  <div class="hb-media-library-header">
    <h1>{{i18n "media_gallery.title"}}</h1>

    <div class="hb-media-library-tabs">
      <button
        class={{concat "btn " (if (eq this.activeTab "all") "btn-primary" "btn-default")}}
        type="button"
        {{on "click" (fn this.switchTab "all")}}
      >
        {{i18n "media_gallery.all"}}
      </button>

      <button
        class={{concat "btn " (if (eq this.activeTab "mine") "btn-primary" "btn-default")}}
        type="button"
        {{on "click" (fn this.switchTab "mine")}}
      >
        {{i18n "media_gallery.mine"}}
      </button>
    </div>

    <div>
      <button class="btn btn-primary" type="button" {{on "click" this.toggleUpload}}>
        {{i18n "media_gallery.upload"}}
      </button>
    </div>
  </div>

  {{#if this.noticeMessage}}
    <div class="alert alert-info">{{this.noticeMessage}}</div>
  {{/if}}

  {{#if this.errorMessage}}
    <div class="alert alert-error">{{this.errorMessage}}</div>
  {{/if}}

  {{#if this.showUpload}}
    <div class="hb-media-library-upload">
      <div class="hb-media-library-upload-grid">
        <div>
          <label class="form-label">{{i18n "media_gallery.pick_file"}}</label>
          <input type="file" accept="image/*,video/*,audio/*" {{on "change" this.onPickFile}} />
          <div class="hint">
            {{#if this.uploadFile}}
              {{this.uploadFile.name}}
            {{/if}}
          </div>
        </div>

        <div>
          <label class="form-label">{{i18n "media_gallery.title_label"}}</label>
          <input type="text" value={{this.uploadTitle}} {{on "input" this.setUploadTitle}} />
        </div>

        <div>
          <label class="form-label">{{i18n "media_gallery.description_label"}}</label>
          <input type="text" value={{this.uploadDescription}} {{on "input" this.setUploadDescription}} />
        </div>

        <div>
          <label class="form-label">{{i18n "media_gallery.tags_label"}}</label>
          <input type="text" value={{this.uploadTagsRaw}} {{on "input" this.setUploadTagsRaw}} />
        </div>

        <div>
          <label class="form-label">{{i18n "media_gallery.gender_label"}}</label>
          <select {{on "change" this.setUploadGender}} value={{this.uploadGender}}>
            <option value="">{{i18n "media_gallery.any"}}</option>
            <option value="male">{{i18n "media_gallery.genders.male"}}</option>
            <option value="female">{{i18n "media_gallery.genders.female"}}</option>
            <option value="non_binary">{{i18n "media_gallery.genders.non_binary"}}</option>
          </select>
        </div>
      </div>

      <div class="hb-media-library-upload-actions">
        <button
          class="btn btn-primary"
          type="button"
          disabled={{this.uploadBusy}}
          {{on "click" this.submitUpload}}
        >
          {{#if this.uploadBusy}}
            {{i18n "media_gallery.uploading"}}
          {{else}}
            {{i18n "media_gallery.upload"}}
          {{/if}}
        </button>

        <button
          class="btn btn-default"
          type="button"
          disabled={{this.uploadBusy}}
          {{on "click" this.resetUploadForm}}
        >
          {{i18n "media_gallery.clear"}}
        </button>
      </div>
    </div>
  {{/if}}

  <div class="hb-media-library-toolbar">
    <input
      type="text"
      placeholder={{i18n "media_gallery.search_placeholder"}}
      value={{this.q}}
      {{on "input" this.setQ}}
    />

    <select {{on "change" this.setMediaType}} value={{this.mediaType}}>
      <option value="">{{i18n "media_gallery.type_label"}}: {{i18n "media_gallery.any"}}</option>
      <option value="image">image</option>
      <option value="video">video</option>
      <option value="audio">audio</option>
    </select>

    <select {{on "change" this.setGender}} value={{this.gender}}>
      <option value="">{{i18n "media_gallery.gender_label"}}: {{i18n "media_gallery.any"}}</option>
      <option value="male">{{i18n "media_gallery.genders.male"}}</option>
      <option value="female">{{i18n "media_gallery.genders.female"}}</option>
      <option value="non_binary">{{i18n "media_gallery.genders.non_binary"}}</option>
    </select>

    <input
      type="text"
      placeholder={{i18n "media_gallery.tags_label"}}
      value={{this.tagsRaw}}
      {{on "input" this.setTagsRaw}}
    />

    <div class="hb-media-library-toolbar-actions">
      {{#if this.isMine}}
        <select {{on "change" this.setStatus}} value={{this.status}} title={{i18n "media_gallery.status_label"}}>
          <option value="">{{i18n "media_gallery.status_all"}}</option>
          <option value="queued">{{i18n "media_gallery.status_queued"}}</option>
          <option value="processing">{{i18n "media_gallery.status_processing"}}</option>
          <option value="ready">{{i18n "media_gallery.status_ready"}}</option>
          <option value="failed">{{i18n "media_gallery.status_failed"}}</option>
        </select>
      {{/if}}

      <select {{on "change" this.setPerPage}} value={{this.perPage}} title={{i18n "media_gallery.per_page_label"}}>
        <option value="20">20</option>
        <option value="24">24</option>
        <option value="40">40</option>
      </select>

      <button class="btn btn-primary" type="button" {{on "click" this.applyFilters}}>
        {{i18n "media_gallery.apply"}}
      </button>

      <button class="btn btn-default" type="button" {{on "click" this.clearFilters}}>
        {{i18n "media_gallery.clear"}}
      </button>
    </div>
  </div>

  {{#if this.loading}}
    <p>{{i18n "loading"}}</p>
  {{else}}
    {{#if (gt this.items.length 0)}}
      <div class="hb-media-library-grid">
        {{#each this.items as |item|}}
          <div class="hb-media-library-card" role="button" tabindex="0" {{on "click" (fn this.openPreview item)}}>
            <div class="hb-media-library-thumb">
              <img alt="" src={{item.thumbnail_url}} loading="lazy" />
            </div>

            <div class="hb-media-library-meta">
              <div class="title">{{item.title}}</div>

              <div class="sub">
                <span>@{{item.uploader_username}}</span>
                <span>{{item.media_type}}</span>
              </div>

              <div class="badges">
                {{#if item.status}}
                  <span class={{concat "badge " (if (eq item.status "ready") "ok" (if (eq item.status "failed") "warn" ""))}}>
                    {{item.status}}
                  </span>
                {{/if}}

                {{#if item.gender}}
                  <span class="badge">{{item.gender}}</span>
                {{/if}}

                {{#if item.tags}}
                  {{#each item.tags as |t|}}
                    <span class="badge">{{t}}</span>
                  {{/each}}
                {{/if}}
              </div>

              <div class="actions">
                <button class="like-btn" type="button" {{on "click" (fn this.toggleLike item)}}>
                  {{#if item.liked}}♥{{else}}♡{{/if}} {{item.likes_count}}
                </button>

                {{#if (and this.isMine (eq item.status "failed"))}}
                  <button class="btn btn-small btn-danger" type="button" {{on "click" (fn this.retryProcessing item)}}>
                    {{i18n "media_gallery.retry"}}
                  </button>
                {{/if}}
              </div>
            </div>
          </div>
        {{/each}}
      </div>

      <div class="hb-media-library-pagination">
        <button class="btn btn-default" type="button" disabled={{not this.hasPrev}} {{on "click" this.goPrev}}>‹</button>
        <div>{{this.page}} / {{this.totalPages}} · {{this.total}} {{i18n "media_gallery.total"}}</div>
        <button class="btn btn-default" type="button" disabled={{not this.hasNext}} {{on "click" this.goNext}}>›</button>
      </div>
    {{else}}
      <p>{{i18n "media_gallery.no_results"}}</p>
    {{/if}}
  {{/if}}

  {{#if this.previewOpen}}
    <div class="hb-media-library-modal-backdrop" role="dialog" aria-modal="true" {{on "click" this.closePreview}}>
      <div class="hb-media-library-modal" {{on "click" this.stopBackdropClick}}>
        <div class="hb-media-library-modal-header">
          <div class="title">{{this.previewItem.title}}</div>
          <button class="btn btn-default" type="button" {{on "click" this.closePreview}}>
            {{i18n "media_gallery.close"}}
          </button>
        </div>

        <div class="hb-media-library-modal-body">
          {{#if this.previewLoading}}
            <p>{{i18n "loading"}}</p>
          {{else}}
            <div class="player">
              {{#if (eq this.previewItem.media_type "image")}}
                <img alt="" src={{this.previewStreamUrl}} />
              {{else if (eq this.previewItem.media_type "video")}}
                <video controls src={{this.previewStreamUrl}}></video>
              {{else if (eq this.previewItem.media_type "audio")}}
                <audio controls src={{this.previewStreamUrl}}></audio>
              {{/if}}
            </div>

            <div class="details">
              {{#if this.previewItem.description}}
                <div>{{this.previewItem.description}}</div>
              {{/if}}

              <div>
                <strong>@{{this.previewItem.uploader_username}}</strong>
                · {{this.previewItem.views_count}} {{i18n "media_gallery.views"}}
                · {{this.previewItem.likes_count}} {{i18n "media_gallery.likes"}}
              </div>
            </div>
          {{/if}}
        </div>
      </div>
    </div>
  {{/if}}
</section>
